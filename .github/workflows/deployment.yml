name: Deployment-CI/CD

on:
  # Execute this pipeline when we make a pull request to the main branch:
  pull_request:
    branches:
      - "main"
    types: [closed]

jobs:
  # Run the collection CI pipeline
  collection-CI:
    name: collection-CI 🚀
    uses: ./.github/workflows/collectionCI.yml

  # Run the trading CI pipeline
  trading-CI:
    name: trading-CI 🚀
    #needs: trading-CI  -- if running synchronously
    uses: ./.github/workflows/tradingCI.yml

  # Run the client CI pipeline
  client-CI:
    name: client-CI 🚀
    #needs: transport-CI
    uses: ./.github/workflows/clientCI.yml

  # Build the docker images for all modules
  image-build:
    if: github.event.pull_request.merged == true
    name: Build & Push Images🚀 🐋
    needs: [collection-CI, trading-CI, client-CI]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout branch 🛎️
        uses: actions/checkout@v3

      - name: Set up JDK 18 🏗️
        uses: actions/setup-java@v3
        with:
          java-version: 18
          distribution: 'temurin'
          cache: maven

      - name: Create Docker images with JIB  🐋️
        run: mvn -T 2C compile package jib:build -e

      - name: Create Docker image for client
        working-directory: ./clipper-fe
        run: |
          docker build -t client:latest -f ./clipper-fe/Dockerfile .
          docker push client:latest

  #deploy the images to a kubernetes stack
  deploy:
    needs: image-build